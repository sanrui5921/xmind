package org.sunrain.project.blog.crawler.processor;

import org.sunrain.project.blog.crawler.HttpClientDownloader;
import us.codecraft.webmagic.Page;
import us.codecraft.webmagic.Site;
import us.codecraft.webmagic.Spider;
import us.codecraft.webmagic.pipeline.ConsolePipeline;
import us.codecraft.webmagic.processor.PageProcessor;

public class JuejinSinglePageProcesser implements PageProcessor {

    /**
     * {
     * "operationName": "",
     * "query": "",
     * "variables": {
     * "tags": [
     * <p>
     * ],
     * "category": "5562b419e4b00c57d9b94ae2",
     * "first": 20,
     * "after": "1.00009428374440001",
     * "order": "POPULAR"
     * },
     * "extensions": {
     * "query": {
     * "id": "653b587c5c7c8a00ddf67fc66f989d42"
     * }
     * }
     * }
     */

    /**
     * {"data":{"articleFeed":{"items":{"edges":[{"node":{"id":"5e0f6122f265da5d262d01d1","commentsCount":48,"hot":false,"hotIndex":638.804,"original":true,"originalUrl":"https://juejin.im/post/5e0f5eec5188253a9d4a436f","rankIndex":0.99917643101478,"screenshot":"","summaryInfo":null,"tags":[{"id":"5597a063e4b08a686ce57030","title":"后端"}],"title":"干货！SQL性能优化，书写高质量SQL语句","type":"post","user":{"id":"5aade3aef265da237a4ccba2","role":"guest","username":"java酱"},"lastCommentTime":"2020-01-08T10:59:39.778Z","likeCount":269,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-05T06:17:59.431Z","updatedAt":"2020-01-08T08:17:13.722Z"}},{"node":{"id":"5e13d4606fb9a0481546d5e9","commentsCount":9,"hot":false,"hotIndex":172.1865,"original":true,"originalUrl":"https://juejin.im/post/5e134a915188253a6d06513e","rankIndex":0.98114974358984,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/7/16f7d756834b47f4?w=2339&h=1654&f=png&s=951602","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"源码分析 | 咋嘞？你的IDEA过期了吧！加个Jar包就破解了，为什么？","type":"post","user":{"id":"5d1dd872f265da1bb31c569b","role":"guest","username":"bugstack虫洞栈"},"lastCommentTime":"2020-01-07T21:56:30.672Z","likeCount":30,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T01:39:23.347Z","updatedAt":"2020-01-08T08:17:38.062Z"}},{"node":{"id":"5e14803ef265da5d62526cf3","commentsCount":0,"hot":false,"hotIndex":4.756,"original":true,"originalUrl":"https://juejin.im/post/5e1473916fb9a0483040cf34","rankIndex":0.96775032158461,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/7/16f80180725b391e?w=690&h=276&f=jpeg&s=38729","summaryInfo":null,"tags":[{"id":"55d13e0700b0de09f8b3c3ed","title":"云计算"}],"title":"百度App网络深度优化番外篇《一》IPv6下Happy Eyeballs的最佳实践","type":"post","user":{"id":"5e0467daf265da3396489638","role":"guest","username":"百度APP技术"},"lastCommentTime":null,"likeCount":1,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T03:08:12.181Z","updatedAt":"2020-01-08T08:07:20.123Z"}},{"node":{"id":"5e1548b1e51d455e6c097f60","commentsCount":0,"hot":false,"hotIndex":9.1716,"original":true,"originalUrl":"https://juejin.im/post/5e153e4a6fb9a048021527b0","rankIndex":0.89439679438961,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/8/16f83192a984fd72?w=624&h=351&f=jpeg&s=29797","summaryInfo":null,"tags":[{"id":"555e9ab6e4b00c57d99560f6","title":"MongoDB"}],"title":"OPPO百万级高并发MongoDB集群性能数十倍提升优化实践（下）","type":"post","user":{"id":"5de0f77e5188256ed73673b8","role":"guest","username":"OPPO互联网技术"},"lastCommentTime":null,"likeCount":2,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T03:13:42.562Z","updatedAt":"2020-01-08T08:17:11.497Z"}},{"node":{"id":"5e1540bcf265da5d1c63221c","commentsCount":0,"hot":false,"hotIndex":7.7283,"original":true,"originalUrl":"https://juejin.im/post/5e153e146fb9a0483d6ec7f1","rankIndex":0.86475624065287,"screenshot":"","summaryInfo":null,"tags":[{"id":"55cdb52740ac79db3570607f","title":"架构"},{"id":"5b34b5ce518825766cb12ca5","title":"容器"}],"title":"蚂蚁金服轻量级类隔离框架概述 | SOFAArk 源码解析","type":"post","user":{"id":"5a42596ff265da43062b06e8","role":"editor","username":"蚂蚁金服分布式架构"},"lastCommentTime":null,"likeCount":2,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T02:38:52.302Z","updatedAt":"2020-01-08T08:17:13.004Z"}},{"node":{"id":"5e14172f6fb9a0481546d68f","commentsCount":7,"hot":false,"hotIndex":106.7694,"original":true,"originalUrl":"https://juejin.im/post/5e1417006fb9a047f3363c41","rankIndex":0.83064736322942,"screenshot":"","summaryInfo":null,"tags":[{"id":"555e9a8de4b00c57d9955eb9","title":"MySQL"},{"id":"5597a063e4b08a686ce57030","title":"后端"}],"title":"《金三银四》面试官：说说事务的ACID，什么是脏读、幻读？","type":"post","user":{"id":"5e005a87f265da33c24ff9ce","role":"guest","username":"Java2B"},"lastCommentTime":"2020-01-07T22:38:57.491Z","likeCount":31,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T07:21:38.378Z","updatedAt":"2020-01-08T08:18:13.127Z"}},{"node":{"id":"5e13d2886fb9a047f7602df0","commentsCount":12,"hot":false,"hotIndex":133.7334,"original":true,"originalUrl":"https://juejin.im/post/5e13d24cf265da5d45542608","rankIndex":0.80049959161095,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"惊呆了！Java程序员最常犯的错竟然是这10个","type":"post","user":{"id":"5bd7fb9ce51d45219836421e","role":"guest","username":"沉默王二"},"lastCommentTime":"2020-01-08T15:12:30.481Z","likeCount":26,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T01:39:34.149Z","updatedAt":"2020-01-08T08:15:13.553Z"}},{"node":{"id":"5e1281d36fb9a0482461985b","commentsCount":13,"hot":false,"hotIndex":306.9686,"original":true,"originalUrl":"https://juejin.im/post/5e0ee53ee51d45414a471075","rankIndex":0.74482779291209,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/3/16f6b84c83705545?w=960&h=640&f=webp&s=151950","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"},{"id":"55c1748160b28fd99e49ea68","title":"程序员"}],"title":"年终总结-2019年，我的副业元年？","type":"post","user":{"id":"59199e22a22b9d0058279886","role":"guest","username":"我是十三"},"lastCommentTime":"2020-01-08T13:56:04.537Z","likeCount":23,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-06T00:39:47.175Z","updatedAt":"2020-01-08T08:17:39.074Z"}},{"node":{"id":"5e1441e2e51d45415e5c564a","commentsCount":2,"hot":false,"hotIndex":74.5967,"original":true,"originalUrl":"https://juejin.im/post/5e14411c6fb9a04838192b31","rankIndex":0.74036454305754,"screenshot":"","summaryInfo":null,"tags":[{"id":"555e9abae4b00c57d9956122","title":"Git"}],"title":"最近从 0 学习Git，详细分类总结了这份 Git 命令宝典","type":"post","user":{"id":"5a795ad66fb9a063557d8da8","role":"guest","username":"帅地"},"lastCommentTime":"2020-01-08T09:18:01.707Z","likeCount":24,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T09:44:52.575Z","updatedAt":"2020-01-08T08:17:13.202Z"}},{"node":{"id":"5e1510d56fb9a047f0002cd6","commentsCount":0,"hot":false,"hotIndex":5.2086,"original":true,"originalUrl":"https://juejin.im/post/5e1510975188253a782d8873","rankIndex":0.71181219342594,"screenshot":"","summaryInfo":null,"tags":[{"id":"58c8ac9244d90400682037f1","title":"Spring Boot"}],"title":"SpringBoot 2.X整合Mybatis","type":"post","user":{"id":"5db98e336fb9a0202610c25b","role":"guest","username":"宜春"},"lastCommentTime":null,"likeCount":1,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T03:02:09.334Z","updatedAt":"2020-01-08T08:18:12.815Z"}},{"node":{"id":"5e149f99f265da5d32468dcd","commentsCount":0,"hot":false,"hotIndex":7.8575,"original":true,"originalUrl":"https://juejin.im/post/5e149f81f265da5d381d11c7","rankIndex":0.66150715640248,"screenshot":"","summaryInfo":null,"tags":[{"id":"583bd28aac502e006c277c8c","title":"Kubernetes"}],"title":"2020 年对 Kubernetes 的 5 个预测","type":"post","user":{"id":"5cb5cf4de51d456e896349e1","role":"guest","username":"Linux中国"},"lastCommentTime":null,"likeCount":2,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T03:08:03.700Z","updatedAt":"2020-01-08T08:12:19.267Z"}},{"node":{"id":"5e1401336fb9a0482259fae7","commentsCount":1,"hot":false,"hotIndex":81.3312,"original":true,"originalUrl":"https://juejin.im/post/5e1401335188253a937f44cf","rankIndex":0.64582571984684,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"Redis 6.0 新特性之集群代理","type":"post","user":{"id":"589f05e1128fe1006ce71e21","role":"guest","username":"冷冷gg"},"lastCommentTime":"2020-01-07T18:30:22.047Z","likeCount":36,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T06:21:58.657Z","updatedAt":"2020-01-08T08:15:13.490Z"}},{"node":{"id":"5e11ec8ce51d45415d597965","commentsCount":14,"hot":false,"hotIndex":192.0309,"original":true,"originalUrl":"https://juejin.im/post/5e0c3c38f265da5d1a446a8c","rankIndex":0.55250852286463,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"【原理探究】女朋友问我ArrayList遍历时删除元素的正确姿势是什么？","type":"post","user":{"id":"5b370a42e51d4558ce5eb969","role":"guest","username":"NotFound9"},"lastCommentTime":"2020-01-07T09:30:50.291Z","likeCount":43,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-06T06:03:47.728Z","updatedAt":"2020-01-08T08:16:14.389Z"}},{"node":{"id":"5e13ca8fe51d4540e929a2cc","commentsCount":4,"hot":false,"hotIndex":84.7522,"original":true,"originalUrl":"https://juejin.im/post/5e0f39945188253a941374a8","rankIndex":0.53440744879889,"screenshot":"","summaryInfo":null,"tags":[{"id":"584a63628e450a006c52f169","title":"Kafka"}],"title":"Kafka源码篇 --- 可能是你看过最详细的缓冲区RecordAccumulator解读","type":"post","user":{"id":"5c2400afe51d45451758aa96","role":"guest","username":"说出你的愿望吧丷"},"lastCommentTime":"2020-01-07T08:34:36.771Z","likeCount":44,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T01:39:40.674Z","updatedAt":"2020-01-08T08:17:13.860Z"}},{"node":{"id":"5e0d3af55188253a7d0efca0","commentsCount":38,"hot":false,"hotIndex":887.3051,"original":true,"originalUrl":"https://juejin.im/post/5e0c8ebde51d4541233fd271","rankIndex":0.47883390947141,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/1/16f611012fbc32d6?w=725&h=106&f=png&s=64817","summaryInfo":null,"tags":[{"id":"55979fe6e4b08a686ce562fe","title":"面试"},{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"《大厂面试》京东+百度一面，不小心都拿了Offer","type":"post","user":{"id":"59b416065188257e671b670a","role":"guest","username":"敖丙"},"lastCommentTime":"2020-01-08T10:34:10.101Z","likeCount":221,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-02T00:36:05.286Z","updatedAt":"2020-01-08T08:16:14.261Z"}},{"node":{"id":"5e0e0bc65188253aba200c2c","commentsCount":24,"hot":false,"hotIndex":624.3233,"original":true,"originalUrl":"https://juejin.im/post/5e0e0bc66fb9a047eb2d335d","rankIndex":0.47325696517898,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"美团面试官问我一个字符的String.length()是多少，我说是1，面试官说你回去好好学一下吧","type":"post","user":{"id":"5be1bd47e51d45562a666aec","role":"guest","username":"公众号_程序员乔戈里"},"lastCommentTime":"2020-01-07T18:11:47.001Z","likeCount":91,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-03T08:12:21.488Z","updatedAt":"2020-01-08T08:18:13.698Z"}},{"node":{"id":"5e153d9ae51d454139377312","commentsCount":0,"hot":false,"hotIndex":2.6131,"original":true,"originalUrl":"https://juejin.im/post/5e153d9a6fb9a048217a1de7","rankIndex":0.46487511755657,"screenshot":"","summaryInfo":null,"tags":[{"id":"583bd28aac502e006c277c8c","title":"Kubernetes"}],"title":"Serverless Kubernetes 入门：对 Kubernetes 做减法","type":"post","user":{"id":"5ad01d036fb9a028d444fc82","role":"guest","username":"阿里巴巴云原生"},"lastCommentTime":null,"likeCount":0,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-08T02:48:56.369Z","updatedAt":"2020-01-08T08:11:13.337Z"}},{"node":{"id":"5e0ea712e51d45413846f1c9","commentsCount":21,"hot":false,"hotIndex":636.7388,"original":true,"originalUrl":"https://juejin.im/post/5e0ea712e51d4540ec4f4118","rankIndex":0.45485660397169,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"我的面试标准：1.能干活；2.Java基础好；3.熟悉分布式框架","type":"post","user":{"id":"59fbb2daf265da4319559f3a","role":"guest","username":"SnailClimb"},"lastCommentTime":"2020-01-08T12:02:12.173Z","likeCount":205,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-03T02:29:38.550Z","updatedAt":"2020-01-08T08:15:36.495Z"}},{"node":{"id":"5e13d456f265da5d1125767b","commentsCount":1,"hot":false,"hotIndex":56.2296,"original":true,"originalUrl":"https://juejin.im/post/5e13248e5188253ab849d125","rankIndex":0.39731816075949,"screenshot":"https://user-gold-cdn.xitu.io/2020/1/6/16f7ac9ce27f1d67?w=793&h=386&f=png&s=375690","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"前后端分离项目，引入Spring Cloud Gateway遇到的一个问题！","type":"post","user":{"id":"5cf7c1d7f265da1bc07e28b7","role":"guest","username":"MacroZheng"},"lastCommentTime":"2020-01-07T13:22:04.114Z","likeCount":7,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T03:05:19.100Z","updatedAt":"2020-01-08T08:18:13.183Z"}},{"node":{"id":"5e13c6695188253a90711952","commentsCount":2,"hot":false,"hotIndex":54.401,"original":true,"originalUrl":"https://juejin.im/post/5e130136e51d4541227ab610","rankIndex":0.38455042489207,"screenshot":"","summaryInfo":null,"tags":[{"id":"559a7207e4b08a686d25703e","title":"Java"}],"title":"《提升能力，涨薪可待》-Java多线程与并发之ThreadLocal","type":"post","user":{"id":"5cd27385e51d453f146bb8e7","role":"guest","username":"Ccww"},"lastCommentTime":"2020-01-08T11:38:29.492Z","likeCount":20,"eventInfo":null,"viewerHasLiked":false,"createdAt":"2020-01-07T02:51:26.621Z","updatedAt":"2020-01-08T08:13:36.872Z"}}],"pageInfo":{"hasNextPage":true,"endCursor":"0.384550424892069975"}}}}}
     */

    private Site site = Site.me()
            .addHeader("Host", "juejin.im")
            .addHeader("Sec-Fetch-Mode", "navigate")
            .addHeader("Sec-Fetch-Site", "same-origin")
            .addHeader("Sec-Fetch-User", "?1")
            .addHeader("Cache-Control", "max-age=0")
            .addHeader("Upgrade-Insecure-Requests", "1")
            .addHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9")
            .addHeader("Accept-Encoding", "gzip, deflate, br")
            .addHeader("User-Agent", "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.88 Safari/537.36")
            .addHeader("Cookie", "gr_user_id=687ecd2d-a55a-4741-988d-f3906e26cdf7; _ga=GA1.2.689447525.1484297212; ab={}; MEIQIA_EXTRA_TRACK_ID=8d5343dec68511e68378020af009bdc2; grwng_uid=40761b93-3106-4484-b936-f0727bb35c2e; Hm_lvt_93bbd335a208870aa1f296bcd6842e5e=1577092279,1577177708,1577177840,1577178824; auth=; auth.sig=25Jg_aucc6SpX1VH8RlCoh6azLU; _gid=GA1.2.928623778.1578277197; SLARDAR_WEB_ID=588f5574-2840-4161-acbf-c0ac51534699; QINGCLOUDELB=229d9a3634d498216e02f8b4f3770be609f51ba16147f64a21f5d51a89fcd206|XhWMU|XhWMU; gr_session_id_89669d96c88aefbc=8fbee3b6-359b-4db7-be96-e29b20507a76; Hm_lpvt_93bbd335a208870aa1f296bcd6842e5e=1578470486; gr_session_id_89669d96c88aefbc_8fbee3b6-359b-4db7-be96-e29b20507a76=true");

    @Override
    public void process(Page page) {
        System.out.println("#################################################");
//        System.out.println(page.getHtml().$(".username", "text"));
//        System.out.println(page.getHtml().xpath("//*[@id=\"wrap\"]/div/div/div[3]/ul[1]/li[1]/div[2]/h2/a/text()"));
        System.out.println(page.getHtml().css("#juejin > div.view-container > main > div > div > div.feed.welcome__feed > ul > li:nth-child(2) > div > div > a > div > div.info-box > div.info-row.title-row > a", "text"));
        System.out.println(page.getHtml().css("#juejin > div.view-container > main > div > div.main-area.article-area.shadow > article"));
        //System.out.println(page.getHtml().css("#TopstoryContent > div > div > div > div:nth-child(1) > div > div > h2 > a", "text"));
        //System.out.println(page.getHtml().css("#Popover2-toggle > a:nth-child(1)"));
        //System.out.println(page.getHtml().$("#juejin > div.view-container > main > div > div.main-area.article-area.shadow > article > div.author-info-block > div > div > time", "datetime"));
        //System.out.println(page.getHtml().$("#juejin > div.view-container > main > div > div.sidebar.sidebar > div.sidebar-block.author-block.shadow > div.block-body > div:nth-child(2) > span > span"));
        //System.out.println(page.getHtml().$("#juejin > div.view-container > main > div > div.main-area.article-area.shadow > article > div.article-content").toString());
        System.out.println("#################################################");
    }

    @Override
    public Site getSite() {
        return site;
    }

    public static void main(String[] args) {
        Spider.create(new JuejinSinglePageProcesser()).setDownloader(new HttpClientDownloader()).addUrl("https://juejin.im/post/5e156c80f265da5d3c6de72a")
                .addPipeline(new ConsolePipeline()).run();
    }
}
